---
output:
  pdf_document: default
  html_document: default
geometry: left=1cm,right=1cm,top=1cm,bottom=1.5cm
---
```{r load packages, echo = FALSE, message = FALSE, warning=FALSE}
library(tidyverse)
library(tsibble)
library(latex2exp)
library(magrittr)
library(patchwork)
library(lubridate)
library(feasts)
library(forecast)
library(zoo)
library(fable)
library(sandwich)
library(lmtest)
library(tseries)
library(gridExtra)

theme_set(theme_minimal())
knitr::opts_chunk$set(dpi=1000)
```

## (1 point) Task 0b: Introduction 

We now ask the question of whether the data collected from January 1998 to the present has different characteristics which could lead us to additional or different conclusions than those which the dataset from 1958 until 1997 yielded.

We assume that the collection process for both datasets is identical.

It is worth noting that the "present" dataset contains only about 24 years, or 293 months, compared to the 39 years, or 468 months contained in the "1997" dataset.


## (3 points) Task 1b: Create a modern data pipeline for Mona Loa CO2 data.

As instructed we pulled created a pipeline to pull down the weekly Mona Loa CO2 data.

Within the dataset the weeks ending on dates; 2008-06-29, 2008-07-06 , 2008-07-13 , 2005-10-16, contained the measurement value -999.99, which cannot be accurate.  We "stubbed" those four dates with values similar to the weekly values for the weeks directly before or after.  We did not remove those data outright as doing so could cause problems within the utilization of the timeseries downstream.  


```{r echo = FALSE, message = FALSE, warming=FALSE}

#Create a data pipeline that starts by reading from the appropriate URL, and ends by saving an object called `co2_present` that is a suitable time series object. #load from National Oceanic and Atmospheric Web site.
#filter, mutate, and turn into tsibble object

#Grab Monthly Data -- May not use this.
co2_present_monthly <- read.table('https://gml.noaa.gov/webdata/ccgg/trends/co2/co2_mm_mlo.txt') %>%
  filter(V1 >= 1998)%>%
  mutate(index = yearmonth(as.yearmon(paste(V1, V2), "%Y %m"))) %>%
  mutate(value = V4) %>%
  mutate(log_value = log(V4)) %>% 
  dplyr::select(c("index","value","log_value")) %>%
  as_tsibble(index=index)

#In Examining this data there are two perios where collections are incorrect on a weekly basis.
# 1.  Period 
#545 2008-06-08 387.74 5.960335
#546 2008-06-15 388.11 5.961289
#547 2008-06-22 387.53 5.959793
#548 2008-06-29 -999.99 NaN
#549 2008-07-06 -999.99 NaN
#550 2008-07-13 -999.99 NaN
#    2005-10-16 -999.99 NaN
#
#Grab weekly data
co2_present <- read.table('https://gml.noaa.gov/webdata/ccgg/trends/co2/co2_weekly_mlo.txt') %>%
  filter(V1 >= 1998)%>%
  mutate(index = as.Date(as.Date(paste(V1,V2,V3, sep="-")) )) %>%
  mutate(value = V5) %>%
  filter(value > 200) %>%
  mutate(log_value = log(value)) %>% 
  dplyr::select(c("index","value","log_value"))
  

#dates I'm manually putting values in.
index <- as.Date(c('2008-06-29','2008-07-06','2008-07-13','2005-10-16'))
value <- c(387.74,388.11,387.53,377.5)
log_value <- log(value)
df_insert <- data.frame(index,value,log_value)

co2_present <- bind_rows(
  co2_present,
  df_insert
) %>% as_tsibble(index=index)

#Aggregate the weekly to monthly
co2_present_weekly_agg_monthly <- as.data.frame(co2_present) %>%
  filter(year(index) >= 1998)%>%
  mutate(index = yearmonth(index)) %>%
  group_by(index)  %>% 
  summarize(value=mean(value))  %>% 
  mutate(log_value = log(value)) %>% 
  dplyr::select(c("index","value","log_value")) %>%
  as_tsibble(index=index)

```


```{r echo = FALSE, message = FALSE}

#old data
co2_ts <- tsibble::as_tsibble(co2) %>%
  mutate(log_value = log(value))

plot_1997 <- co2_ts %>%
  ggplot + 
  aes(x=index, y=value) + 
  geom_line(color = 'steelblue') +
  labs(
    title = TeX(r'(Monthly Mean $CO_2$ 1958 through 1997)'),
    x = 'Month and Year',
    y = TeX(r'($CO_2$ parts per million)')
  )

hist_1997 <- co2_ts %>%
  ggplot(aes(x=value)) + geom_histogram(bins=8) + labs(title="Histogram 1958 through 1997")
acf_1997 <- ggAcf(co2_ts$value, lag.max=(15*12)) + labs(title="ACF 1958 through 1997")
pacf_1997 <- ggPacf(co2_ts$value, lag.max=(15*12)) + labs(title="PACF 1958 through 1997")


plot_present <- co2_present %>%
  ggplot + 
  aes(x=index, y=value) + 
  geom_line(color = 'steelblue') +
  labs(
    title = TeX(r'(Weekly Mean $CO_2$)'),
    subtitle = " 1998 through Present",
    x = 'Month and Year',
    y = TeX(r'($CO_2$ parts per million)')
  )
hist_present <- co2_present %>%
  ggplot(aes(x=value)) + geom_histogram(bins=8) + labs(title="Histogram 1998 through Present")
acf_present <- ggAcf(co2_present$value, lag.max=(15*12)) + labs(title="ACF 1998 through Present")
pacf_present <- ggPacf(co2_present$value, lag.max=(15*12)) + labs(title="PACF 1998 through Present")
#acf_present
#pacf_present
plot_present + acf_present + hist_present + pacf_present + plot_layout(design = "
AAAAACCCC
AAAAACCCC
BBBBBCCCC
BBBBBCCCC
DDDDDCCCC
DDDDDCCCC
")

```

As with the "1997" dataset, we see a clear increasing trend with the same seasonal "wave" pattern.  Seasonal fluctuation does not appear to increase with time, suggesting, again, that an additive model explains the decomposition in this series.  The time series is not stationary, as its mean increases.  Variance presents as constant.

The ACF displays a slow, over-time, decline consistent with a trending time series.  While the ACF plot of the "1997" plot remains above the significance line until lag 140, this ACF plot never crosses the significance line.  

The PACF of this time series has a strong postive spike a lag 1 followed by a pattern consistant with partial autocorrelation.

Our histogram of has no values lower than 365, or nigher than 421, and that these values are not normally distributed.

In order to better understand the differences between these two datasets we examine them side by side.

```{r echo = FALSE, message = FALSE}

plot_present + plot_1997 + hist_present + hist_1997 + plot_layout(design = "
AAAAACCCC
AAAAACCCC
BBBBBDDDD
BBBBBDDDD
")

```

When we start looking graphing the two datasets side by side, the difference of one containing 39 years, and the other 24, begins to hamper our understanding.

We take only the last 293 months of the "1997" dataset and graph it on the same space as the "present" dataset.

```{r echo = FALSE, message = FALSE}


co2_df <-
  co2_ts %>%
  mutate(id = row_number())  %>%
  filter(id > 175) %>%
  mutate(id = row_number()) %>%
  dplyr::select("id","value")  %>%
  as_tsibble()
  #dplyr::select("id","1972 through 1997")

co2_present_df <-
  as.data.frame(co2_present_weekly_agg_monthly) %>%
  mutate(id = row_number()) %>%
  #mutate("1997 through present"=value) %>%
  dplyr::select("id","value")

min_1997 = min(co2_df[,2], na.rm=T)
min_present = min(co2_present_df[,2], na.rm=T)

max_1997 = max(co2_df[,2], na.rm=T)
max_present = max(co2_present_df[,2], na.rm=T)

delta_1997 = max_1997 - min_1997
delta_present = max_present - min_present

delta_between_periods = delta_present - delta_1997



ochart_1 <- ggplot() +
   geom_line(data=co2_df,
             aes(x=id,y=value, color="1973 through 1997"),
             size=1.2) +
   geom_line(data=co2_present_df,
             aes(x=id,y=value, color="1997 through present"),
             size=1.2) +
  labs(x = "Months",
       y = TeX(r'($CO_2$ parts per million)'),
       title="293 month comparison: 1973 through 1997, and 1998 through present.") +
     scale_color_manual(name='Periods',
                     breaks=c('1973 through 1997', '1997 through present'),
                     values=c('1973 through 1997'= '#ebcc34' , 
                              '1997 through present'='#eb3434'))
ochart_1



```

In the 293 months prior to Dec 31, 1997, the atmospheric CO2 rose by `r delta_1997` PPM.  By comparison, in the 293 months prior to May 31, 2022 (the most recent month we have a measurement for), the atmospheric CO2 rose by `r delta_present` PPM.  This is a difference of `r delta_between_periods` PPM during the same time interval.  This could indicate an acceleration in the increase in PPM.

We apply the same "parsing" of the original "1997" dataset and compare the parsed dataset's ACF and PACF graphs to those of the "present" dataset.

```{r echo = FALSE, message = FALSE}

acf_1997 <- ggAcf(co2_df$value, lag.max=(15*12)) + labs(title="ACF (monthly avg) 1973 to 1997")
pacf_1997 <- ggPacf(co2_df$value, lag.max=(15*12)) + labs(title="PACF (monthly avg) 1973 to 1997")

   (acf_1997 | acf_present + labs(title="ACF (weekly avg) 1998 to Present")) /
   (pacf_1997 | pacf_present + labs(title="PACF (weekly avg) 1998 to Present"))  +
  plot_annotation(
      title    = 'ACF and PACF comparison',
    #  subtitle = 'Could be Random Walk',
      tag_levels = 'A')  

```
Parsing the "1997" dataset, to include 293 months only, yields a ACF which crosses the significance line 100, while the weekly data does not cross the significance line.  We notice that the amplitude of oscillation on the "1997" datasets' ACF, is greater than the amplitude of oscillation in the "present" dataset's ACF.

Next we examine the seasonality of the "present" comparing it to the "1997" seasonality.

In order to the present dataset's seasonality 1997 seasonality we aggregate values within the weekly dataset to monthly values, for the purpose of this comparison.

```{r echo = FALSE, message = FALSE, fig.width=6, fig.height=5, warning=FALSE}

df_3_year_season_org <- co2_ts %>%
  filter(year(index)>= 1993)%>%
  select("index","value")

co2_present_no_log <- co2_present_weekly_agg_monthly %>%
  filter(year(index)>= 2017)%>%
  select("index","value")

combined_no_log_latest <- bind_rows(
  df_3_year_season_org,  
  co2_present_no_log
)

seasons_present <- ggseasonplot(x = as.ts(combined_no_log_latest), year.labels=TRUE, year.labels.left=TRUE) +
  ylab(TeX(r'($CO_2$ Parts per Million)')) +
  ggtitle(TeX(r'(Seasonal plot: Monthly mean $CO_2$)'))


seasons_present

```

In the plot above we look at the last 5 years in the "1997" dataset and the last 5 years of the "present" dataset.  

What we are trying to ascertain is if the seasonality has become more extreme.  It is difficult to ascertain if the seasonality has become more extreme based on the graph above.  

We next compare the two subseries graphs looking at each dataset.


```{r echo = FALSE, message = FALSE, fig.width=6, fig.height=4, warning=FALSE}

co2_df_ts <-
  co2_ts %>%
  mutate(id = row_number())  %>%
  filter(id > 175) %>%
  mutate(id = row_number()) %>%
  dplyr::select("index","value")  %>%
  as_tsibble()

subseries_1997 <- ggsubseriesplot(x = as.ts(co2_df_ts)) +
  ylab(TeX(r'($CO_2$ Parts per Million)')) +
  ggtitle(TeX(r'(Subseries plot: Monthly mean $CO_2$ 1973 through 1997)'))

subseries_present <- ggsubseriesplot(x = as.ts(co2_present_no_log)) +
  ylab(TeX(r'($CO_2$ Parts per Million)')) +
  ggtitle(TeX(r'(Subseries plot: Monthly mean $CO_2$ 1998 through 2022)'))


subseries_1997 + subseries_present + plot_layout(design = "
AAAAA
BBBBB
")


```

With this new plot it becomes clearer that the yearly oscillations in PPM are more extreme in the present dataset than in the one ending in 1997.

That is to say the seasonality effect shows a noticeable increase in the magnitude of the fluctuations in the second dataset.

We now remove the seasonal fluctuations in both datasets and graph the increase in atmospheric CO2 PPM.

In order to do this we aggregate our weekly data to monthly data in order to compare on the same scales.

```{r echo = FALSE, message = FALSE, warning = FALSE, fig.width=6, fig.height=3}

co2_df <-
  co2_ts %>%
  mutate(id = row_number())  %>%
  filter(id > 175) %>%
  mutate(year = year(index))  %>%
  index_by(year) %>%
  summarise(avg_value = (sum(value)/12)) %>%  
  mutate(id = row_number()) %>%
  filter(id > 1 ) %>%  
  dplyr::select("id","avg_value")
  #dplyr::select("id","1972 through 1997")

co2_present_df <- co2_present_weekly_agg_monthly %>%
  mutate(year = year(index))  %>%
  index_by(year) %>%
  summarise(avg_value = (sum(value)/12)) %>%  
  mutate(id = row_number())  %>%
  filter(id <= 24) %>%  
  dplyr::select("id","avg_value")


ochart_2 <- ggplot() +
   geom_line(data=co2_df,
             aes(x=id,y=avg_value, color="1973 through 1997"),
             size=1.2) +
   geom_line(data=co2_present_df,
             aes(x=id,y=avg_value, color="1997 through present"),
             size=1.2) +
  labs(x = "Months",
       y = TeX(r'($CO_2$ parts per million)'),
       title="293 month comparison: 1973 through 1997, and 1998 through present.",
       subtitle = "Smoothed") +
     scale_color_manual(name='Periods',
                     breaks=c('1973 through 1997', '1997 through present'),
                     values=c('1973 through 1997'= '#ebcc34' , 
                              '1997 through present'='#eb3434'))
ochart_2


```


We now perform additive and multiplicative decomposition to remove the trend and seasonal movements from our dataset to confirm that the 


```{r echo = FALSE, message = FALSE, warning = FALSE, fig.width=7.5, fig.height=6}
co2_present_monthly <- co2_present %>%
  mutate(log_value = log(value))

dcmp_add <- co2_present %>%
  model(stl = STL(value))

dcmp_multi <- co2_present %>%
 model(stl = STL(log_value))

decomp <- components(dcmp_add) %>% autoplot()
residuals <- components(dcmp_add)%>%
  ACF(remainder) %>%
  autoplot() + labs(title="Additive residuals")
log_decomp <- components(dcmp_multi) %>% autoplot()
log_residuals <- components(dcmp_multi) %>%
  ACF(remainder) %>%
  autoplot() + labs(title="Multiplicative residuals")

grid.arrange(decomp, residuals, log_decomp, log_residuals, nrow = 2, ncol = 2)
```

These graphs confirm that the time series is trending upwards.  In the additive decomposition plots (top left), we see that seasonal fluctuations increase over time.  This confirms our side-by-side graph above showing the increase in seasonal fluctuations between the two time series.

The multiplicative "season_year" decomposition graph is stable, and not visibly increasing.  This means like the "1997" time series, the "present" time series may be multiplicative.

Both residuals plots, again, show our time series as stationary, but not white noise.  This means correlation in the data still exists.

Next we run the ADF test, as well as the PP test to see if the time series is stationary.

H0: The data are not stationary
HA: The data are stationary

```{r echo = FALSE, message = FALSE, warning = FALSE}

co2_present_ts = as.ts(co2_present$value)

adf.test(co2_present_ts, alternative="stationary", k=5)
pp.test(co2_present_ts)


```

The tests above indicate that we can reject the null hypothesis that the time series is non-stationary.

The Unit Root tests above indicate that this time series is difference stationary.  

This contradicts our visual EDA, which shows a changing mean, given the strong upward trend.  

We should note that the tests above are testing whether the time series are difference stationary.  We apply a linear model and then graph its residuals.

```{r echo = FALSE, message = FALSE}
library(lmtest)

trModel <- lm(co2_present_ts ~ c(1:length(co2_present_ts)))

checkresiduals(trModel) 

```

Graphing the residuals appears to show a mean reverting process.  That is to say the residuals are stationary and not trending, and appear to be normally distributed.

Finally, we run an ADF and PP test on the residuals, and we again, see that the null hypothesis of non-trend-stationary can be ignored.

H0: The data are not stationary
HA: The data are stationary


```{r echo = FALSE, message = FALSE}

adf.test(trModel$residuals, alternative="stationary", k=5)
pp.test(trModel$residuals, alternative="stationary")

```

Despite the fact that the ADF and PP tests indicate the data series is stationary, our visual analysis of this data set suggests that it is non-stationary as its mean is increasing over time.  We will ignore the ADF and PP test results as they can sometimes be of low power.

## (1 point) Task 2b: Compare linear model forecasts against realized CO2

```{r echo = FALSE, message = FALSE, warning = FALSE, fig.width=6, fig.height=6}

future_df <- new_data(co2_ts, n=23 * 12)

fit_quadratic <- co2_ts %>%
   model(trend_model = TSLM(value ~ trend()+I(trend()^2))) 

fit_quadratic_season <- co2_ts %>%
  model(trend_model = TSLM(value ~ trend() + I(trend()^2) + season())) 

lm_prediction_based_on_1997_data <- fit_quadratic_season %>%
  forecast(new_data = future_df) %>%
  autoplot() +  
  labs(
    title = TeX(r'(Predicted Monthly Mean $CO_2$)'),
    subtitle = "Quadratic Model w/ Trend & Seasonal Effects",
    x = 'Month and Year',
    y = TeX(r'($CO_2$ parts per million)')
  )

data_and_lm_prediction_overlay <- fit_quadratic_season %>%
  forecast(new_data = future_df) %>%
  autoplot(co2_present) +  
  labs(
    title = TeX(r'(Weekly Mean $CO_2$)'),
    subtitle = "(Series, with Linear Prediction Overlay)",
    x = 'Month and Year',
    y = TeX(r'($CO_2$ parts per million)')
  )

(plot_present | lm_prediction_based_on_1997_data) /
  data_and_lm_prediction_overlay

```

In the top-left, we plot the 1998-present time series, next to it, we plot the prediction yielded by the best-fitting linear model we developed against the "1997" data set.  Beneath the two plots we overlay the original time series with the prediction.  Towards the middle of time time series, the fit is nearly perfect.  At both the beginning and end of the time series, there are barely visible differences the prediction and the "real" underlying time series.  

We predict 23 years from Dec 31, 1997, which means the predict values are through December 31 2021.  Our "present" time series contains data "through" May 2022, which means we have an addition 5 months of data, indicated by the solid black line extending upwards out of the prediction.

The linear model is very accurate.

## (1 point) Task 3b: Compare ARIMA models forecasts against realized CO2  




```{r echo = FALSE, message = FALSE, warning = FALSE, fig.width=6, fig.height=6}


future_d <- new_data(co2_ts, n=23 * 12)

data_and_arima_prediction_overlay <- co2_ts %>%
  model(ARIMA(value ~ 0 + pdq(0,1,3) + PDQ(0,1,1))) %>%
  forecast(new_data = future_d) %>%
  autoplot(co2_present)  +
  labs(
    title = TeX(r'(Weekly Mean $CO_2$)'),
    subtitle = "(Series, with ARIMA Prediction Overlay)",
    x = 'Month and Year',
    y = TeX(r'($CO_2$ parts per million)')
  )

arima_prediction_based_on_1997_data<-co2_ts %>%
  model(ARIMA(value ~ 0 + pdq(0,1,3) + PDQ(0,1,1))) %>%
  forecast(new_data = future_d) %>%
  autoplot() +  
  labs(
    title = TeX(r'(Predicted Monthly Mean $CO_2$)'),
    subtitle = "(ARIMA Model w/ Trend & Seasonal Effects)",
    x = 'Month and Year',
    y = TeX(r'($CO_2$ parts per million)')
  )

(plot_present | arima_prediction_based_on_1997_data) /
  data_and_arima_prediction_overlay
#plot_present
#arima_prediction_based_on_1997_data
#data_and_arima_prediction_overlay

```
In the top-left, we plot the 1998-present time series, next to it, we plot the prediction yielded by the best-fitting ARIMA model we developed against the "1997" data set.  Beneath the two plots we overlay the original time series with the prediction.  The overlay shows a divergence between predicted ARIMA values and the actual trend.  

We predict 23 years from Dec 31, 1997, which means the predict values are through December 31 2021.  Our "present" time series contains data "through" May 2022, which means we have an addition 5 months of data, indicated by the solid black line extending upwards out of the prediction.

The linear model does not predict as accurately as the linear model.

To demonstrate this we graph both on top of one another below.


```{r echo = FALSE, message = FALSE, warning = FALSE, fig.width=6, fig.height=6}

data_and_lm_prediction_overlay / 
  data_and_arima_prediction_overlay

```   