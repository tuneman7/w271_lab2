---
output:
  pdf_document: default
  html_document: default
---
```{r load packages, echo = FALSE, message = FALSE, warning=FALSE}
library(tidyverse)
library(tsibble)
library(latex2exp)
library(magrittr)
library(patchwork)
library(lubridate)
library(feasts)
library(forecast)
library(zoo)
library(fable)
library(sandwich)
library(lmtest)
library(tseries)
library(gridExtra)

theme_set(theme_minimal())
knitr::opts_chunk$set(dpi=1000)
```

## (1 point) Task 0b: Introduction 

We now ask the question of whether the data collected from January 1998 to the present has different characteristics which could lead us to additional or different conclusions than those which the data set from 1958 until 1997 yielded.

We assume that the collection process for both datasets is identical.

It is worth noting that the "present" data set contains only about 24 years, or 293 months, compared to the 39 years, or 468 months contained in the "1997" dataset.

## (3 points) Task 1b: Create a modern data pipeline for Mona Loa CO2 data.


```{r echo = FALSE, message = FALSE}

#Create a data pipeline that starts by reading from the appropriate URL, and ends by saving an object called `co2_present` that is a suitable time series object. #load from National Oceanic and Atmospheric Web site.
#filter, mutate, and turn into tsibble object
co2_present <- read.table('https://gml.noaa.gov/webdata/ccgg/trends/co2/co2_mm_mlo.txt') %>%
  filter(V1 >= 1998)%>%
  mutate(index = yearmonth(as.yearmon(paste(V1, V2), "%Y %m"))) %>%
  mutate(value = V4) %>%
  mutate(log_value = log(V4)) %>% 
  dplyr::select(c("index","value","log_value")) %>%
  as_tsibble(index=index)

```

```{r echo = FALSE, message = FALSE}

#old data
co2_ts <- tsibble::as_tsibble(co2) %>%
  mutate(log_value = log(value))

plot_1997 <- co2_ts %>%
  ggplot + 
  aes(x=index, y=value) + 
  geom_line(color = 'steelblue') +
  labs(
    title = TeX(r'(Monthly Mean $CO_2$ 1958 through 1997)'),
    x = 'Month and Year',
    y = TeX(r'($CO_2$ parts per million)')
  )

hist_1997 <- co2_ts %>%
  ggplot(aes(x=value)) + geom_histogram(bins=8) + labs(title="Histogram 1958 through 1997")
acf_1997 <- ggAcf(co2_ts$value, lag.max=(15*12)) + labs(title="ACF 1958 through 1997")
pacf_1997 <- ggPacf(co2_ts$value, lag.max=(15*12)) + labs(title="PACF 1958 through 1997")


plot_present <- co2_present %>%
  ggplot + 
  aes(x=index, y=value) + 
  geom_line(color = 'steelblue') +
  labs(
    title = TeX(r'(Monthly Mean $CO_2$ 1998 through Present)'),
    x = 'Month and Year',
    y = TeX(r'($CO_2$ parts per million)')
  )
hist_present <- co2_present %>%
  ggplot(aes(x=value)) + geom_histogram(bins=8) + labs(title="Histogram 1998 through Present")
acf_present <- ggAcf(co2_present$value, lag.max=(15*12)) + labs(title="ACF 1998 through Present")
pacf_present <- ggPacf(co2_present$value, lag.max=(15*12)) + labs(title="PACF 1998 through Present")

plot_present + acf_present + hist_present + pacf_present + plot_layout(design = "
AAAAACCCC
AAAAACCCC
BBBBBCCCC
BBBBBCCCC
DDDDDCCCC
DDDDDCCCC
")

```
As with the "1997" data set, we see a clear increasing trend with the same seasonal "wave" pattern.  Seasonal fluctuation does not appear to increase with time, suggesting, again, that an additive model explains the decomposition in this series.  The time series is not stationary, as its mean increases.  Variance presents as constant.

The ACF displays a slow, over-time, decline consistent with a trending time series.  While the ACF plot of the "1997" plot remains above the significance line until lag 140, this ACF plot crosses the significance line at close to 100.  As mentioned above, this "present" data set contains only 24 years, as opposed to 39, which is possibly the cause of this cross in the significance line at close to 100.

The PACF has a large positive spike at lag 1, followed by a smaller negative spike at log 2, then oscillates between positive and negative lags with progressively lower levels of significance.

Our histogram of has no values lower than 365, or nigher than 421, and that these values are not normally distributed.

In order to better understand the differences between these two datasets we examine them side by side.

```{r echo = FALSE, message = FALSE}

plot_present + plot_1997 + hist_present + hist_1997 + plot_layout(design = "
AAAAACCCC
AAAAACCCC
BBBBBDDDD
BBBBBDDDD
")

```

When we start looking graphing the two data sets side by side, the difference of one containing 39 years, and the other 24, begins to hamper our understanding.

We take only the last 293 months of the "1997" data set and graph it on the same space as the "present" data set.

```{r echo = FALSE, message = FALSE}


co2_df <-
  co2_ts %>%
  mutate(id = row_number())  %>%
  filter(id > 175) %>%
  mutate(id = row_number()) %>%
  dplyr::select("id","value")  %>%
  as_tsibble()
  #dplyr::select("id","1972 through 1997")

co2_present_df <-
  as.data.frame(co2_present) %>%
  mutate(id = row_number()) %>%
  #mutate("1997 through present"=value) %>%
  dplyr::select("id","value")

min_1997 = min(co2_df[,2], na.rm=T)
min_present = min(co2_present_df[,2], na.rm=T)

max_1997 = max(co2_df[,2], na.rm=T)
max_present = max(co2_present_df[,2], na.rm=T)

delta_1997 = max_1997 - min_1997
delta_present = max_present - min_present

delta_between_periods = delta_present - delta_1997



ochart_1 <- ggplot() +
   geom_line(data=co2_df,
             aes(x=id,y=value, color="1973 through 1997"),
             size=1.2) +
   geom_line(data=co2_present_df,
             aes(x=id,y=value, color="1997 through present"),
             size=1.2) +
  labs(x = "Months",
       y = TeX(r'($CO_2$ parts per million)'),
       title="293 month comparison: 1973 through 1997, and 1998 through present.") +
     scale_color_manual(name='Periods',
                     breaks=c('1973 through 1997', '1997 through present'),
                     values=c('1973 through 1997'= '#ebcc34' , 
                              '1997 through present'='#eb3434'))
ochart_1



```

In the 293 months prior to Dec 31, 1997, the atmospheric CO2 rose by `r delta_1997` PPM.  By comparison, in the 293 months prior to May 31, 2022 (the most recent month we have a measuring for), the atmospheric CO2 rose by `r delta_present` PPM.  This is a difference of `r delta_between_periods` PPM during the same time interval.  This could indicate an acceleration in the increase in PPM.

We apply the same "parsing" of the original "1997" data set and compare the parsed dataset's ACF and PACF graphs to those of the "present" data set.

```{r echo = FALSE, message = FALSE}

acf_1997 <- ggAcf(co2_df$value, lag.max=(15*12)) + labs(title="ACF 1973 through 1997")
pacf_1997 <- ggPacf(co2_df$value, lag.max=(15*12)) + labs(title="PACF 1973 through 1997")

   (acf_1997 | acf_present) /
   (pacf_1997 | pacf_present)  +
  plot_annotation(
      title    = 'ACF and PACF comparison',
    #  subtitle = 'Could be Random Walk',
      tag_levels = 'A')  

```

Parsing the "1997" data set to include 293 months only yields a ACF which crosses the significance line at about the same lag as the ACF plot of the "present" data set does.  We notice that the degree of oscillation on the "1997" ACF is greater than the degree of osilation on the "present" data set.

Next we examine the seasonality of the "present" comparing it to the "1997" seasonality.

```{r echo = FALSE, message = FALSE, fig.width=6, fig.height=5, warning=FALSE}

df_3_year_season_org <- co2_ts %>%
  filter(year(index)>= 1993)%>%
  select("index","value")

co2_present_no_log <- co2_present %>%
  filter(year(index)>= 2017)%>%
  select("index","value")

combined_no_log_latest <- bind_rows(
  df_3_year_season_org,  
  co2_present_no_log
)

seasons_present <- ggseasonplot(x = as.ts(combined_no_log_latest), year.labels=TRUE, year.labels.left=TRUE) +
  ylab(TeX(r'($CO_2$ Parts per Million)')) +
  ggtitle(TeX(r'(Seasonal plot: Monthly mean $CO_2$)'))


seasons_present

```

In the plot above we look at the last 5 years in the "1997" data set and the last 5 years of the "present" data set.  

What we are trying to ascertain is if the seasonality has become more extreme.  It is difficult to ascertain if the seasonality has become more extreme based on the graph above.  

We next compare the two subseries graphs looking at each data set.


```{r echo = FALSE, message = FALSE, fig.width=6, fig.height=4, warning=FALSE}


co2_df_ts <-
  co2_ts %>%
  mutate(id = row_number())  %>%
  filter(id > 175) %>%
  mutate(id = row_number()) %>%
  dplyr::select("index","value")  %>%
  as_tsibble()

subseries_1997 <- ggsubseriesplot(x = as.ts(co2_df_ts)) +
  ylab(TeX(r'($CO_2$ Parts per Million)')) +
  ggtitle(TeX(r'(Subseries plot: Monthly mean $CO_2$ 1973 through 1997)'))

subseries_present <- ggsubseriesplot(x = as.ts(co2_present_no_log)) +
  ylab(TeX(r'($CO_2$ Parts per Million)')) +
  ggtitle(TeX(r'(Subseries plot: Monthly mean $CO_2$ 1998 through 2022)'))


subseries_1997 + subseries_present + plot_layout(design = "
AAAAA
BBBBB
")


```

With this new plot it becomes clearer that the yearly oscillations in PPM are more extreme in the present data set than in the one ending in 1997.

That is to say the seasonality effect shows a noticeable increase in the magnitude of the fluctuations in the second data set.

We now remove the seasonal fluctuations in both data sets and graph the increase in atmospheric CO2 PPM.

```{r echo = FALSE, message = FALSE, warning = FALSE, fig.width=6, fig.height=3}

co2_df <-
  co2_ts %>%
  mutate(id = row_number())  %>%
  filter(id > 175) %>%
  mutate(year = year(index))  %>%
  index_by(year) %>%
  summarise(avg_value = (sum(value)/12)) %>%  
  mutate(id = row_number()) %>%
  filter(id > 1 ) %>%  
  dplyr::select("id","avg_value")
  #dplyr::select("id","1972 through 1997")

co2_present_df <- co2_present %>%
  mutate(year = year(index))  %>%
  index_by(year) %>%
  summarise(avg_value = (sum(value)/12)) %>%  
  mutate(id = row_number())  %>%
  filter(id <= 24) %>%  
  dplyr::select("id","avg_value")


ochart_2 <- ggplot() +
   geom_line(data=co2_df,
             aes(x=id,y=avg_value, color="1973 through 1997"),
             size=1.2) +
   geom_line(data=co2_present_df,
             aes(x=id,y=avg_value, color="1997 through present"),
             size=1.2) +
  labs(x = "Months",
       y = TeX(r'($CO_2$ parts per million)'),
       title="293 month comparison: 1973 through 1997, and 1998 through present.",
       subtitle = "Smoothed") +
     scale_color_manual(name='Periods',
                     breaks=c('1973 through 1997', '1997 through present'),
                     values=c('1973 through 1997'= '#ebcc34' , 
                              '1997 through present'='#eb3434'))
ochart_2


```


We now perform additive and multiplicative decomposition to remove the trend and seasonal movements from our data set to confirm that the 


```{r echo = FALSE, message = FALSE, warning = FALSE, fig.width=7.5, fig.height=6}
co2_present <- co2_present %>%
  mutate(log_value = log(value))

dcmp_add <- co2_present %>%
  model(stl = STL(value))

dcmp_multi <- co2_present %>%
 model(stl = STL(log_value))

decomp <- components(dcmp_add) %>% autoplot()
residuals <- components(dcmp_add)%>%
  ACF(remainder) %>%
  autoplot() + labs(title="Additive residuals")
log_decomp <- components(dcmp_multi) %>% autoplot()
log_residuals <- components(dcmp_multi) %>%
  ACF(remainder) %>%
  autoplot() + labs(title="Multiplicative residuals")

grid.arrange(decomp, residuals, log_decomp, log_residuals, nrow = 2, ncol = 2)
```

These graphs confirm that the time series is trending upwards.  In the additive decomposition plots (top left), we see that seasonal fluxuations increase over time.  This confirms our side-by-side graph above showing the increase in seasonal fluctuations between the two time series.

The multiplicative "season_year" decomposition graph is stable, and not visibly increasing.  This means like the "1997" time series, the "present" time series may be multiplicative.

Both residuals plots, again, show our time series as stationary, but not white noise.  This means correlation in the data still exists.


```{r echo = FALSE, message = FALSE, warning = FALSE}

co2_present_ts = as.ts(co2_present$value)

adf.test(co2_present_ts, alternative="stationary", k=5)
pp.test(co2_present_ts)


```

The tests above indicate that we can reject the null hypothesis that the time series is non-stationary.

The Unit Root tests above indicate that this time series is difference stationary.  

This contradicts our visual EDA, which shows a changing mean, given the strong upward trend.  

We should note that the tests above are testing whether the time series are difference stationary.  We apply a linear model and then graph its residuals.

```{r}
library(lmtest)

trModel <- lm(co2_present_ts ~ c(1:length(co2_present_ts)))
plot.ts(residuals(trModel))

```
Graphing the residuals appears to show a mean reverting process.  That is to say the residuals are stationary and not trending.

Finally we run an ADF and PP test on the residuals, and we again, see that the null hypothesis of non-trend stationary can be ignored.


```{r}

adf.test(trModel$residuals, alternative="stationary", k=5)
pp.test(trModel$residuals, alternative="stationary")

```

## (3 points) Task 2a: Linear time trend model

Fit a linear time trend model to the `co2` series, and examine the characteristics of the residuals. Compare this to a quadratic time trend model. Discuss whether a logarithmic transformation of the data would be appropriate. Fit a polynomial time trend model that incorporates seasonal dummy variables, and use this model to generate forecasts to the year 2020. 

> Would be appropriate - look at week 7, because we think this is additive we should not take the logarithm

> https://github.com/mids-271/summer_22_central/blob/master/Live_session_and_solutions/LS_7_Solutions/LS-7-Solutions.pdf - pg 12 & 13